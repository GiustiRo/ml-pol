import { Injectable, inject } from "@angular/core";
import { MediaPipeService } from "./mediapipe.service";
import { BrandConfig, PreconfigureService, mlpolConfig } from "./preconfigure.service";

export function buildElement(tag: string, attributes: { [key: string]: string } = {}, children: HTMLElement[] | Text[] = []): HTMLElement {
    const element = document.createElement(tag);
    for (const key in attributes) element.setAttribute(key, attributes[key]);
    for (const child of children) element.appendChild(child);
    return element;
}

export function setMessage(message: string, step?: number) {
    const messageElement = document.querySelector('#message');
    if (!messageElement?.getAttribute('step') || messageElement?.getAttribute('step') != step?.toString()) {
        messageElement?.setAttribute('step', step!.toString());
        messageElement!.innerHTML = message;
    }
}

@Injectable({ providedIn: 'root' })
export class MLPOL {
    private mp = inject(MediaPipeService);
    private configs = inject(PreconfigureService);

    public initMLPOL(mlpolConfig?: mlpolConfig, brandConfig?: BrandConfig) {
        if (mlpolConfig) this.configs.setMLPOLConfig(mlpolConfig);
        if (brandConfig) this.configs.setBrandConfig(brandConfig);
        this.mp.initMP().then(() => {
            this.createInitialLayout();
        });
    }


    private createInitialLayout() {
        // Main wraper.
        const mainLayout = buildElement('main', { class: 'page-wrap df fdc jc-sb ai-center mx-auto' });
        this.apendLayout(document.body, mainLayout);

        // Video, Canvas and Overlays
        const userVideo = buildElement('video', { class: 'user-media', id: 'user-video', autoplay: '', playsinline: '' });
        const userCanvas = buildElement('canvas', { class: 'user-media', id: 'user-canvas' });
        const userOverlay = buildElement('div', { class: 'user-media', id: 'user-overlay' });
        const userMessage = buildElement('div', { class: 'user-media', id: 'user-message' }, [buildElement('span', { id: 'message' }, [document.createTextNode('')])]);
        const challengePage = buildElement('section', { class: 'challenge-page' });
        this.apendLayout(challengePage, userVideo);
        this.apendLayout(challengePage, userCanvas);
        this.apendLayout(challengePage, userOverlay);
        this.apendLayout(challengePage, userMessage);
        this.apendLayout(document.body, challengePage);

        if (this.configs.brandConfig.logoSrc) {
            const brandLogo = buildElement('img', { class: 'brand-logo', src: this.configs.brandConfig.logoSrc! });
            this.apendLayout(mainLayout, brandLogo);
        }

        // Challenges.
        const challengesLayout = buildElement('div', { class: 'challenges df fdc jc-center ai-stretch' });
        this.apendLayout(mainLayout, challengesLayout);
        Object.entries(this.mp.userChallenges).forEach(([key, value]) => {
            const svg = this.svgs[value.id];
            if (this.mp.userChallenges[key].challenge && (this.configs.mlpolConfig.challenges as any)[value.id].required) {
                const challengeCard = buildElement('div', { class: 'challenge df dfr ai-center jc-sb', id: value.id }, [
                    buildElement('h3', { class: 'm-0' }, [document.createTextNode(this.mp.userChallenges[key].label)]),
                    // buildElement('span', {}, [document.createTextNode('')]),
                ]);
                svg && challengeCard.insertAdjacentHTML('beforeend', svg);
                challengeCard.addEventListener('click', () => this.mp.userChallenges[key].action!());
                this.apendLayout(challengesLayout, challengeCard);
            }
        });


        // Done Button (activated once all challenges are done).
        const button = buildElement('button', { class: '', disabled: '' }, [document.createTextNode('COMPLETE')]);
        button.addEventListener('click', () => alert('DONE!'));
        this.apendLayout(mainLayout, button);

        const brandName = buildElement('small', { class: 'brand-name' }, [document.createTextNode(this.configs.brandConfig.name)]);
        this.apendLayout(mainLayout, brandName);
    }

    private apendLayout(parent: HTMLElement, child: HTMLElement) { parent.appendChild(child) }




    svgs: any = {
        selfie: `<div class="asset-wrap"><svg width="50" height="50" viewBox="0 0 930 930" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M637.597 399.849C637.597 435.658 618.244 464.689 594.37 464.689C570.496 464.689 551.143 435.658 551.143 399.849C551.143 364.038 570.496 335.008 594.37 335.008C618.244 335.008 637.597 364.038 637.597 399.849Z" fill="#1C274C"/>
    <path d="M378.235 399.849C378.235 435.658 358.882 464.689 335.008 464.689C311.135 464.689 291.781 435.658 291.781 399.849C291.781 364.038 311.135 335.008 335.008 335.008C358.882 335.008 378.235 364.038 378.235 399.849Z" fill="#1C274C"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M375.796 1.95905e-05H378.235C396.14 1.95905e-05 410.655 14.5152 410.655 32.4202C410.655 50.3252 396.14 64.8404 378.235 64.8404C295.809 64.8404 237.251 64.9091 192.829 70.8817C149.339 76.7286 124.282 87.694 105.988 105.988C87.694 124.282 76.7286 149.339 70.8817 192.829C64.9091 237.251 64.8404 295.809 64.8404 378.235C64.8404 396.14 50.3252 410.655 32.4202 410.655C14.5152 410.655 1.95905e-05 396.14 1.95905e-05 378.235V375.796C-0.000844947 296.356 -0.00127989 233.433 6.61978 184.189C13.4332 133.509 27.7897 92.4887 60.139 60.139C92.4887 27.7897 133.509 13.4332 184.189 6.61978C233.433 -0.00127989 296.356 -0.000844947 375.796 1.95905e-05ZM736.552 70.8817C692.127 64.9091 633.568 64.8404 551.143 64.8404C533.238 64.8404 518.723 50.3252 518.723 32.4202C518.723 14.5152 533.238 1.95905e-05 551.143 1.95905e-05H553.581C633.023 -0.000844947 695.944 -0.00127989 745.188 6.61978C795.868 13.4332 836.89 27.7897 869.241 60.139C901.588 92.4887 915.943 133.509 922.76 184.189C929.378 233.433 929.378 296.356 929.378 375.797V378.235C929.378 396.14 914.862 410.655 896.958 410.655C879.053 410.655 864.538 396.14 864.538 378.235C864.538 295.809 864.469 237.251 858.495 192.829C852.65 149.339 841.684 124.282 823.39 105.988C805.096 87.694 780.038 76.7286 736.552 70.8817ZM32.4202 518.723C50.3252 518.723 64.8404 533.238 64.8404 551.143C64.8404 633.568 64.9091 692.127 70.8817 736.552C76.7286 780.038 87.694 805.096 105.988 823.39C124.282 841.684 149.339 852.65 192.829 858.495C237.251 864.469 295.809 864.538 378.235 864.538C396.14 864.538 410.655 879.053 410.655 896.958C410.655 914.862 396.14 929.378 378.235 929.378H375.797C296.356 929.378 233.433 929.378 184.189 922.76C133.509 915.943 92.4887 901.588 60.139 869.241C27.7897 836.89 13.4332 795.868 6.61978 745.188C-0.00127989 695.944 -0.000844947 633.023 1.95905e-05 553.581V551.143C1.95905e-05 533.238 14.5152 518.723 32.4202 518.723ZM896.958 518.723C914.862 518.723 929.378 533.238 929.378 551.143V553.581C929.378 633.023 929.378 695.944 922.76 745.188C915.943 795.868 901.588 836.89 869.241 869.241C836.89 901.588 795.868 915.943 745.188 922.76C695.944 929.378 633.023 929.378 553.581 929.378H551.143C533.238 929.378 518.723 914.862 518.723 896.958C518.723 879.053 533.238 864.538 551.143 864.538C633.568 864.538 692.127 864.469 736.552 858.495C780.038 852.65 805.096 841.684 823.39 823.39C841.684 805.096 852.65 780.038 858.495 736.552C864.469 692.127 864.538 633.568 864.538 551.143C864.538 533.238 879.053 518.723 896.958 518.723ZM308.963 618.291C319.625 603.906 339.93 600.888 354.314 611.552C385.8 634.886 423.801 648.403 464.689 648.403C505.577 648.403 543.578 634.886 575.065 611.552C589.45 600.888 609.754 603.906 620.414 618.291C631.078 632.677 628.061 652.981 613.675 663.641C571.641 694.799 520.236 713.244 464.689 713.244C409.142 713.244 357.737 694.799 315.703 663.641C301.318 652.981 298.301 632.677 308.963 618.291Z" fill="#1C274C"/>
    </svg></div>`,
        proofOfLife: `<div class="asset-wrap">
        <svg width="50" height="50" viewBox="0 0 930 930" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M375.796 1.95906e-05H378.235C396.14 1.95906e-05 410.655 14.5152 410.655 32.4202C410.655 50.3252 396.14 64.8403 378.235 64.8403C295.809 64.8403 237.251 64.9091 192.829 70.8817C149.339 76.7286 124.282 87.694 105.988 105.988C87.694 124.282 76.7286 149.339 70.8817 192.829C64.9091 237.251 64.8403 295.809 64.8403 378.235C64.8403 396.14 50.3252 410.655 32.4202 410.655C14.5152 410.655 1.95906e-05 396.14 1.95906e-05 378.235V375.796C-0.000844947 296.356 -0.00127983 233.433 6.61978 184.189C13.4332 133.509 27.7897 92.4887 60.139 60.139C92.4887 27.7897 133.509 13.4332 184.189 6.61978C233.433 -0.00127983 296.356 -0.000844947 375.796 1.95906e-05ZM736.552 70.8817C692.127 64.9091 633.568 64.8403 551.143 64.8403C533.238 64.8403 518.723 50.3252 518.723 32.4202C518.723 14.5152 533.238 1.95906e-05 551.143 1.95906e-05H553.581C633.023 -0.000844947 695.944 -0.00127983 745.188 6.61978C795.867 13.4332 836.89 27.7897 869.241 60.139C901.588 92.4887 915.943 133.509 922.76 184.189C929.378 233.433 929.378 296.356 929.378 375.797V378.235C929.378 396.14 914.862 410.655 896.958 410.655C879.053 410.655 864.538 396.14 864.538 378.235C864.538 295.809 864.469 237.251 858.495 192.829C852.65 149.339 841.684 124.282 823.39 105.988C805.096 87.694 780.038 76.7286 736.552 70.8817ZM32.4202 518.723C50.3252 518.723 64.8403 533.238 64.8403 551.143C64.8403 633.568 64.9091 692.127 70.8817 736.552C76.7286 780.038 87.694 805.096 105.988 823.39C124.282 841.684 149.339 852.65 192.829 858.495C237.251 864.469 295.809 864.538 378.235 864.538C396.14 864.538 410.655 879.053 410.655 896.958C410.655 914.862 396.14 929.378 378.235 929.378H375.797C296.356 929.378 233.433 929.378 184.189 922.76C133.509 915.943 92.4887 901.588 60.139 869.241C27.7897 836.89 13.4332 795.867 6.61978 745.188C-0.00127983 695.944 -0.000844947 633.023 1.95906e-05 553.581V551.143C1.95906e-05 533.238 14.5152 518.723 32.4202 518.723ZM896.958 518.723C914.862 518.723 929.378 533.238 929.378 551.143V553.581C929.378 633.023 929.378 695.944 922.76 745.188C915.943 795.867 901.588 836.89 869.241 869.241C836.89 901.588 795.867 915.943 745.188 922.76C695.944 929.378 633.023 929.378 553.581 929.378H551.143C533.238 929.378 518.723 914.862 518.723 896.958C518.723 879.053 533.238 864.538 551.143 864.538C633.568 864.538 692.127 864.469 736.552 858.495C780.038 852.65 805.096 841.684 823.39 823.39C841.684 805.096 852.65 780.038 858.495 736.552C864.469 692.127 864.538 633.568 864.538 551.143C864.538 533.238 879.053 518.723 896.958 518.723Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M405.064 612.357C361.663 612.357 319.454 621.903 282.779 639.544C282.778 639.545 282.777 639.545 282.776 639.546C246.107 657.19 216.947 681.951 197.266 710.357C187.215 724.863 167.307 728.475 152.801 718.424C138.294 708.373 134.683 688.465 144.734 673.959C171.3 635.616 209.397 603.93 255.069 581.954L255.072 581.953C300.741 559.984 352.466 548.447 405.064 548.447C457.662 548.447 509.387 559.984 555.056 581.953L555.059 581.954C600.731 603.93 638.827 635.616 665.396 673.957C675.448 688.463 671.837 708.371 657.331 718.423C642.825 728.475 622.917 724.864 612.865 710.358C593.181 681.952 564.02 657.19 527.351 639.545M405.064 612.357C448.465 612.357 490.674 621.903 527.348 639.544Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M415.064 265.955C362.966 265.955 320.732 308.189 320.732 360.287C320.732 412.384 362.966 454.618 415.064 454.618C467.162 454.618 509.395 412.384 509.395 360.287C509.395 308.189 467.162 265.955 415.064 265.955ZM264.822 360.287C264.822 277.31 332.088 210.045 415.064 210.045C498.04 210.045 565.305 277.31 565.305 360.287C565.305 443.263 498.04 510.528 415.064 510.528C332.088 510.528 264.822 443.263 264.822 360.287Z" fill="#1C274C"/>
<path d="M690.5 448C690.5 454.904 696.096 460.5 703 460.5C709.904 460.5 715.5 454.904 715.5 448L690.5 448ZM711.839 262.161C706.957 257.28 699.043 257.28 694.161 262.161L614.612 341.711C609.73 346.592 609.73 354.507 614.612 359.388C619.493 364.27 627.408 364.27 632.289 359.388L703 288.678L773.711 359.388C778.592 364.27 786.507 364.27 791.388 359.388C796.27 354.507 796.27 346.592 791.388 341.711L711.839 262.161ZM715.5 448L715.5 356.885L690.5 356.885L690.5 448L715.5 448ZM715.5 356.885L715.5 271L690.5 271L690.5 356.885L715.5 356.885Z" fill="#1C274C"/>
</svg></div>`,
        identification: `<div class="asset-wrap">
        <svg width="50" height="50" viewBox="0 0 930 930" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M375.796 1.95906e-05H378.235C396.14 1.95906e-05 410.655 14.5152 410.655 32.4202C410.655 50.3252 396.14 64.8403 378.235 64.8403C295.809 64.8403 237.251 64.9091 192.829 70.8817C149.339 76.7286 124.282 87.694 105.988 105.988C87.694 124.282 76.7286 149.339 70.8817 192.829C64.9091 237.251 64.8403 295.809 64.8403 378.235C64.8403 396.14 50.3252 410.655 32.4202 410.655C14.5152 410.655 1.95906e-05 396.14 1.95906e-05 378.235V375.796C-0.000844947 296.356 -0.00127983 233.433 6.61978 184.189C13.4332 133.509 27.7897 92.4887 60.139 60.139C92.4887 27.7897 133.509 13.4332 184.189 6.61978C233.433 -0.00127983 296.356 -0.000844947 375.796 1.95906e-05ZM736.552 70.8817C692.127 64.9091 633.568 64.8403 551.143 64.8403C533.238 64.8403 518.723 50.3252 518.723 32.4202C518.723 14.5152 533.238 1.95906e-05 551.143 1.95906e-05H553.581C633.023 -0.000844947 695.944 -0.00127983 745.188 6.61978C795.867 13.4332 836.89 27.7897 869.241 60.139C901.588 92.4887 915.943 133.509 922.76 184.189C929.378 233.433 929.378 296.356 929.378 375.797V378.235C929.378 396.14 914.862 410.655 896.958 410.655C879.053 410.655 864.538 396.14 864.538 378.235C864.538 295.809 864.469 237.251 858.495 192.829C852.65 149.339 841.684 124.282 823.39 105.988C805.096 87.694 780.038 76.7286 736.552 70.8817ZM32.4202 518.723C50.3252 518.723 64.8403 533.238 64.8403 551.143C64.8403 633.568 64.9091 692.127 70.8817 736.552C76.7286 780.038 87.694 805.096 105.988 823.39C124.282 841.684 149.339 852.65 192.829 858.495C237.251 864.469 295.809 864.538 378.235 864.538C396.14 864.538 410.655 879.053 410.655 896.958C410.655 914.862 396.14 929.378 378.235 929.378H375.797C296.356 929.378 233.433 929.378 184.189 922.76C133.509 915.943 92.4887 901.588 60.139 869.241C27.7897 836.89 13.4332 795.867 6.61978 745.188C-0.00127983 695.944 -0.000844947 633.023 1.95906e-05 553.581V551.143C1.95906e-05 533.238 14.5152 518.723 32.4202 518.723ZM896.958 518.723C914.862 518.723 929.378 533.238 929.378 551.143V553.581C929.378 633.023 929.378 695.944 922.76 745.188C915.943 795.867 901.588 836.89 869.241 869.241C836.89 901.588 795.867 915.943 745.188 922.76C695.944 929.378 633.023 929.378 553.581 929.378H551.143C533.238 929.378 518.723 914.862 518.723 896.958C518.723 879.053 533.238 864.538 551.143 864.538C633.568 864.538 692.127 864.469 736.552 858.495C780.038 852.65 805.096 841.684 823.39 823.39C841.684 805.096 852.65 780.038 858.495 736.552C864.469 692.127 864.538 633.568 864.538 551.143C864.538 533.238 879.053 518.723 896.958 518.723Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M733.588 478.769H729.151H727.521H201.412V610.615C201.412 625.191 207.195 639.164 217.479 649.462C227.763 659.759 241.704 665.538 256.235 665.538H678.765C693.296 665.538 707.237 659.759 717.521 649.462C727.805 639.164 733.588 625.191 733.588 610.615V478.769ZM201.412 385H727.521H729.151C729.151 314 722.409 307.433 717.521 302.538C707.237 292.241 693.296 286.462 678.765 286.462H256.235C241.704 286.462 224.784 288.203 214.5 298.5C204.216 308.797 201.412 325.5 201.412 385ZM234.235 550.154H393.471V632.615H234.235V550.154ZM426.294 550.154H547.118V632.615H426.294V550.154ZM256.235 226H678.765C709.327 226 738.638 238.157 760.248 259.795C781.859 281.434 794 310.783 794 341.385V610.615C794 641.217 781.859 670.566 760.248 692.205C738.638 713.843 709.327 726 678.765 726H256.235C225.673 726 196.362 713.843 174.752 692.205C153.141 670.566 141 641.217 141 610.615V341.385C141 310.783 153.141 281.434 174.752 259.795C196.362 238.157 225.673 226 256.235 226Z" fill="#1C274C"/>
</svg>
        </div>`,
        knowYourCustomer: `<div class="asset-wrap">
        <svg width="50" height="50" viewBox="0 0 930 930" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M375.796 1.95906e-05H378.235C396.14 1.95906e-05 410.655 14.5152 410.655 32.4202C410.655 50.3252 396.14 64.8403 378.235 64.8403C295.809 64.8403 237.251 64.9091 192.829 70.8817C149.339 76.7286 124.282 87.694 105.988 105.988C87.694 124.282 76.7286 149.339 70.8817 192.829C64.9091 237.251 64.8403 295.809 64.8403 378.235C64.8403 396.14 50.3252 410.655 32.4202 410.655C14.5152 410.655 1.95906e-05 396.14 1.95906e-05 378.235V375.796C-0.000844947 296.356 -0.00127983 233.433 6.61978 184.189C13.4332 133.509 27.7897 92.4887 60.139 60.139C92.4887 27.7897 133.509 13.4332 184.189 6.61978C233.433 -0.00127983 296.356 -0.000844947 375.796 1.95906e-05ZM736.552 70.8817C692.127 64.9091 633.568 64.8403 551.143 64.8403C533.238 64.8403 518.723 50.3252 518.723 32.4202C518.723 14.5152 533.238 1.95906e-05 551.143 1.95906e-05H553.581C633.023 -0.000844947 695.944 -0.00127983 745.188 6.61978C795.867 13.4332 836.89 27.7897 869.241 60.139C901.588 92.4887 915.943 133.509 922.76 184.189C929.378 233.433 929.378 296.356 929.378 375.797V378.235C929.378 396.14 914.862 410.655 896.958 410.655C879.053 410.655 864.538 396.14 864.538 378.235C864.538 295.809 864.469 237.251 858.495 192.829C852.65 149.339 841.684 124.282 823.39 105.988C805.096 87.694 780.038 76.7286 736.552 70.8817ZM32.4202 518.723C50.3252 518.723 64.8403 533.238 64.8403 551.143C64.8403 633.568 64.9091 692.127 70.8817 736.552C76.7286 780.038 87.694 805.096 105.988 823.39C124.282 841.684 149.339 852.65 192.829 858.495C237.251 864.469 295.809 864.538 378.235 864.538C396.14 864.538 410.655 879.053 410.655 896.958C410.655 914.862 396.14 929.378 378.235 929.378H375.797C296.356 929.378 233.433 929.378 184.189 922.76C133.509 915.943 92.4887 901.588 60.139 869.241C27.7897 836.89 13.4332 795.867 6.61978 745.188C-0.00127983 695.944 -0.000844947 633.023 1.95906e-05 553.581V551.143C1.95906e-05 533.238 14.5152 518.723 32.4202 518.723ZM896.958 518.723C914.862 518.723 929.378 533.238 929.378 551.143V553.581C929.378 633.023 929.378 695.944 922.76 745.188C915.943 795.867 901.588 836.89 869.241 869.241C836.89 901.588 795.867 915.943 745.188 922.76C695.944 929.378 633.023 929.378 553.581 929.378H551.143C533.238 929.378 518.723 914.862 518.723 896.958C518.723 879.053 533.238 864.538 551.143 864.538C633.568 864.538 692.127 864.469 736.552 858.495C780.038 852.65 805.096 841.684 823.39 823.39C841.684 805.096 852.65 780.038 858.495 736.552C864.469 692.127 864.538 633.568 864.538 551.143C864.538 533.238 879.053 518.723 896.958 518.723Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M612 202H318C307.507 202 299 210.507 299 221V711C299 721.493 307.507 730 318 730H612C622.493 730 631 721.493 631 711V221C631 210.507 622.493 202 612 202ZM318 141C273.817 141 238 176.817 238 221V711C238 755.183 273.817 791 318 791H612C656.183 791 692 755.183 692 711V221C692 176.817 656.183 141 612 141H318Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M352.596 474.45C352.596 461.347 360.979 450.725 371.321 450.725H558C568.341 450.725 576.725 461.347 576.725 474.45C576.725 487.553 568.341 498.175 558 498.175H371.321C360.979 498.175 352.596 487.553 352.596 474.45Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M414.822 599.9C414.822 586.797 423.206 576.175 433.547 576.175H495.774C506.115 576.175 514.499 586.797 514.499 599.9C514.499 613.003 506.115 623.625 495.774 623.625H433.547C423.206 623.625 414.822 613.003 414.822 599.9Z" fill="#1C274C"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M383.709 349C383.709 335.897 392.092 325.275 402.434 325.275H526.884C537.226 325.275 545.609 335.897 545.609 349C545.609 362.103 537.226 372.725 526.884 372.725H402.434C392.092 372.725 383.709 362.103 383.709 349Z" fill="#1C274C"/>
</svg>
        </div>`,
    }
}